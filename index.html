<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyScript Pro | Developer Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #020617;
            --bg-card: #0f172a;
            --primary: #6366f1;
            --primary-light: #818cf8;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #1e293b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --glass: rgba(15, 23, 42, 0.85);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; line-height: 1.5; overflow-x: hidden; }
        .hidden { display: none !important; }

      /* Badge Positioning */
.badge-container {
    position: absolute;
    top: 10px;
    left: 10px;
    display: flex;
    gap: 6px;
    z-index: 10;
}

/* Layout Fix: Post Time Stamp */
.post-time-stamp {
    position: absolute;
    top: 10px;
    right: 12px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-main);
    background: rgba(15, 23, 42, 0.7); /* Dark glass effect */
    padding: 4px 8px;
    border-radius: 6px;
    backdrop-filter: blur(4px);
    z-index: 5;
    pointer-events: none;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* Ensure the thumb-wrapper can contain absolute elements */
.thumb-wrapper {
    position: relative; 
    height: 180px;
    background: #020617;
    border-radius: 16px 16px 0 0;
    overflow: hidden;
}

.owner-badge {
    background: var(--primary);
    color: white;
    font-size: 10px;
    font-weight: 800;
    padding: 4px 8px;
    border-radius: 6px;
    text-transform: uppercase;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

#toggle-btn {
    transition: all 0.2s ease;
    opacity: 0.7;
}

#toggle-btn:hover {
    opacity: 1;
    transform: translateY(-50%) scale(1.1) !important;
}

/* Optional: Subtle glow when password is shown */
input[type="text"]#login-pass {
    border-color: var(--primary) !important;
}

/* Redefining your saved-badge slightly for consistency */
.saved-badge {
    position: static !important; /* Overrides absolute to work in flex container */
    background: var(--warning);
    color: #000;
    font-size: 10px;
    font-weight: 800;
    padding: 4px 8px;
    border-radius: 6px;
    text-transform: uppercase;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
        /* --- Moving Silver Gradient Logo --- */
        .logo-anim {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(90deg, #71717a, #f8fafc, #71717a);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: silverMove 3s linear infinite;
        }
		
		.saved-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: var(--warning);
    color: #000;
    font-size: 10px;
    font-weight: 800;
    padding: 4px 8px;
    border-radius: 6px;
    text-transform: uppercase;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    z-index: 2;
}

       @keyframes silverMove {
            to { background-position: 200% center; }
        }

        /* --- Custom Notifications --- */
        #notif-stack { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .es-notif { 
            pointer-events: auto; background: var(--bg-card); border: 1px solid var(--border); border-left: 5px solid var(--primary);
            padding: 15px 25px; border-radius: 12px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            min-width: 280px; transform: translateX(120%); transition: 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            display: flex; align-items: center; justify-content: space-between;
        }
        .es-notif.show { transform: translateX(0); }
        .es-notif.success { border-left-color: var(--success); }
        .es-notif.danger { border-left-color: var(--danger); }

        /* --- Navigation --- */
        nav { background: var(--glass); backdrop-filter: blur(12px); padding: 0 40px; height: 70px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .nav-links { display: flex; gap: 8px; align-items: center; }
        .tab-link { color: var(--text-muted); text-decoration: none; font-weight: 500; font-size: 14px; cursor: pointer; padding: 8px 16px; border-radius: 8px; transition: 0.2s; }
        .tab-link:hover { color: var(--text-main); background: rgba(255,255,255,0.05); }
        .tab-link.active { color: white; background: var(--primary); }

        /* --- Layout --- */
        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
        .script-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
        
        .script-card { 
            background: var(--bg-card); 
            border-radius: 16px; 
            border: 1px solid var(--border); 
            position: relative; 
            transition: 0.3s; 
            cursor: pointer;
            /* FIX: Changed from hidden to allow dropdowns to pop out */
            overflow: visible; 
        }
        .script-card:hover { transform: translateY(-5px); border-color: var(--primary); }

        /* --- Dropdowns --- */
        .dropdown-btn { background: rgba(0,0,0,0.6); color: white; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .dropdown-menu { 
            position: absolute; 
            background: #1e293b; 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            z-index: 1000; 
            overflow: hidden; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.4); 
            min-width: 150px; 
            display: none; 
            right: 15px;
            top: 45px;
        }
        .dropdown-menu.active { display: block; }
        .dropdown-menu button { display: block; width: 100%; padding: 12px 15px; background: none; border: none; color: white; text-align: left; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .dropdown-menu button:hover { background: var(--primary); }

        /* FIX: Round top corners here since card overflow is visible */
        .thumb-wrapper { height: 180px; background: #020617; position: relative; border-radius: 16px 16px 0 0; overflow: hidden; }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .card-content { padding: 20px; }
        .tag-pill { font-size: 10px; padding: 2px 8px; border-radius: 4px; background: var(--border); color: var(--text-muted); margin-right: 5px; text-transform: uppercase; }

        /* --- Modals --- */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(2, 6, 23, 0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(8px); }
        .modal-content { background: var(--bg-card); width: 95%; max-width: 850px; max-height: 90vh; overflow-y: auto; border-radius: 24px; padding: 40px; position: relative; border: 1px solid var(--border); }
        
        .code-box { background: #020617; padding: 20px; border-radius: 12px; font-family: monospace; font-size: 13px; color: #818cf8; border: 1px solid var(--border); margin: 20px 0; overflow-x: auto; }
        
        input, textarea, select { width: 100%; background: #020617; border: 1px solid var(--border); color: white; padding: 14px; border-radius: 10px; margin: 10px 0; font-family: inherit; box-sizing: border-box; outline: none; }
        select { cursor: pointer; appearance: none; }

        .btn { padding: 12px 24px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        
        /* Join Game Button Specifics */
        .btn-join { background: #2b3544; border: 1px solid var(--border); color: #fff; width: 100%; margin-top: 12px; padding: 10px; font-size: 12px; justify-content: center; }
        .btn-join:hover { background: var(--success); border-color: var(--success); }

        /* --- Interaction --- */
        .interaction-row { display: flex; gap: 10px; margin: 20px 0; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .stat-btn { background: #1e293b; border: 1px solid var(--border); color: var(--text-muted); padding: 10px 15px; border-radius: 10px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .stat-btn.active-up { color: var(--success); border-color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .stat-btn.active-down { color: var(--danger); border-color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .stat-btn.active-fav { color: var(--warning); border-color: var(--warning); background: rgba(245, 158, 11, 0.1); }

        /* --- Comments --- */
        .comment { background: rgba(255,255,255,0.02); padding: 18px; border-radius: 14px; margin-bottom: 15px; border: 1px solid var(--border); position: relative; overflow: visible; }
        .comment-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .comment-info { display: flex; flex-direction: column; }
        .comment-user { font-weight: 700; font-size: 14px; color: var(--primary-light); }
        .comment-date { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        .comment-body { font-size: 14px; color: var(--text-main); word-wrap: break-word; line-height: 1.6; padding-right: 40px; }
        .comment-menu-btn { position: absolute; top: 15px; right: 15px; z-index: 10; }
    </style>
</head>
<body>

<div id="notif-stack"></div>

<div id="confirm-modal" class="modal-overlay hidden" style="z-index: 20000;">
    <div class="modal-content" style="max-width: 400px; text-align: center; padding: 30px;">
        <div style="font-size: 50px; margin-bottom: 15px;">‚ö†Ô∏è</div>
        <h2 id="confirm-title" style="margin: 0 0 10px 0;">Are you sure?</h2>
        <p id="confirm-msg" style="color: var(--text-muted); margin-bottom: 25px;">This action cannot be undone.</p>
        
        <div style="display: flex; gap: 12px;">
            <button class="btn" style="flex: 1; background: #334155; color: white;" onclick="closeConfirm()">Cancel</button>
            <button id="confirm-yes-btn" class="btn" style="flex: 1; background: var(--danger); color: white;">Yes, Delete</button>
        </div>
    </div>
</div>

<nav>
    <div style="display: flex; align-items: center; gap: 20px;">
        <div class="logo-anim">EasyScript</div>
        
        <div style="position: relative; display: flex; align-items: center;">
            <svg style="position: absolute; left: 12px; width: 16px; height: 16px; color: var(--text-muted); pointer-events: none;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="search-input" placeholder="Search scripts..." oninput="renderFeed()" 
                style="margin: 0; padding: 10px 15px 10px 38px; width: 200px; background: rgba(255,255,255,0.05); font-size: 13px;">
        </div>
    </div>

    <div class="nav-links">
        <a class="tab-link active" id="tab-recent" onclick="switchTab('feed', 'recent')">Home</a>
        <a class="tab-link" id="tab-favorites" onclick="switchTab('feed', 'favorites')">Favorites</a>
        <a class="tab-link" id="tab-my" onclick="switchTab('feed', 'my')">My Post</a>
        <a class="tab-link" onclick="switchTab('upload')" id="upload-nav-btn" style="color: var(--primary-light);">+ Upload</a>
        <a id="logout-btn" class="tab-link hidden" onclick="logout()" style="color: var(--danger);">Logout</a>
    </div>
</nav>
<div id="section-auth" class="hidden" style="display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 80px); width: 100%;">
    
    <div style="max-width: 400px; width: 90%; background: var(--bg-card); padding: 40px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); margin: auto;">
        
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="background: var(--primary); width: 50px; height: 50px; border-radius: 12px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 24px;">D</div>
            <h2 style="margin:0; font-size: 24px; font-weight: 700; color: white;">Welcome back</h2>
            <p style="color: var(--text-muted); font-size: 14px; margin-top: 5px;">Enter your details to access the community.</p>
        </div>
        
        <label style="font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; display: block; letter-spacing: 0.5px;">USERNAME</label>
        <input type="text" id="reg-username" placeholder="ScriptGod" style="width: 100%; margin-bottom: 15px; background: #0a0a0a; border: 1px solid #222; border-radius: 10px; padding: 12px; color: #fff;">
        
        <label style="font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; display: block; letter-spacing: 0.5px;">EMAIL ADDRESS</label>
        <input type="email" id="email" placeholder="name@example.com" style="width: 100%; margin-bottom: 15px; background: #0a0a0a; border: 1px solid #222; border-radius: 10px; padding: 12px; color: #fff;">

        <label style="font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; display: block; letter-spacing: 0.5px;">PASSWORD</label>
        <div style="position: relative; width: 100%; margin-bottom: 25px;">
            <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; padding-right: 45px !important; background: #0a0a0a; border: 1px solid #222; border-radius: 10px; padding: 12px; color: #fff;">
            <div onclick="togglePassword()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; opacity: 0.6;">
                <svg id="eye-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </div>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <button class="btn btn-primary" style="width:100%; padding: 14px; border-radius: 8px; font-weight: 600; background: var(--primary); color: white; border: none; cursor: pointer;" onclick="signup()">Create Account</button>
            <button class="btn btn-primary" style="width:100%; padding: 14px; border-radius: 8px; font-weight: 600; background: var(--primary); color: white; border: none; cursor: pointer;" onclick="login()">Log In</button>
        </div>

    </div>
</div>
  <div id="section-upload" class="hidden" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);">
    
    <div style="max-width: 850px; width: 95%; background: var(--bg-card); padding: 40px; border-radius: 24px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); margin: auto;">
        
        <div style="border-bottom: 1px solid var(--border); margin-bottom: 25px; padding-bottom: 15px;">
            <h2 id="upload-header" style="margin:0; font-size: 24px; color: #fff; letter-spacing: -0.5px;">Publish New Script</h2>
            <p style="color: var(--text-muted); font-size: 14px; margin-top: 4px;">Fill out the details below to share your creation.</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="grid-column: span 2;">
                <label style="font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; display: block; letter-spacing: 0.5px;">SCRIPT TITLE</label>
                <input type="text" id="up-title" placeholder="e.g. Universal Aimbot v2" style="width: 100%; background: #0a0a0a; border: 1px solid #222; border-radius: 10px; padding: 12px; color: #fff;">
            </div>
            
            <div>
                <label style="font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; display: block;">KEY SYSTEM</label>
                <select id="up-key" style="width: 100%; background: #0a0a0a; border: 1px solid #222; border-radius: 10px; padding: 12px; color: #fff;">
                    <option value="Keyless">Keyless (Recommended)</option>
                    <option value="Key System">Key System Required</option>
                </select>
            </div>

            <div>
                <label style="font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; display: block;">PRICING</label>
                <select id="up-payment" style="width: 100%; background: #0a0a0a; border: 1px solid #222; border-radius: 10px; padding: 12px; color: #fff;">
                    <option value="Free">Free</option>
                    <option value="Paid">Paid / Premium</option>
                </select>
            </div>

            <div style="grid-column: span 2;">
                <label style="font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; display: block;">ROBLOX GAME ID (OPTIONAL)</label>
                <input type="text" id="up-gameid" placeholder="e.g. 155615604" style="width: 100%; background: #0a0a0a; border: 1px solid #222; border-radius: 10px; padding: 12px; color: #fff;">
            </div>
        </div>

        <div style="margin: 25px 0;">
            <label style="font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; display: block;">THUMBNAIL PREVIEW</label>
            <div id="drop-zone" onclick="document.getElementById('up-thumb-file').click()" style="width: 100%; height: 180px; border: 2px dashed #333; border-radius: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; background: #070707; transition: 0.3s;">
                <div id="upload-placeholder" style="text-align: center;">
                    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" style="margin-bottom: 10px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    <p style="color: var(--text-muted); font-size: 13px; margin: 0;">Recommended: 1280x720 (PNG/JPG)</p>
                </div>
                <img id="upload-img-preview" src="" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                <input type="file" id="up-thumb-file" accept="image/*" style="display: none;" onchange="previewUploadImage(this)">
            </div>
        </div>

        <label style="font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; display: block;">SOURCE CODE (LUA)</label>
        <textarea id="up-script" rows="10" placeholder="-- Paste your code here..." style="width: 100%; font-family: 'Fira Code', monospace; font-size: 13px; color: #79f2bd; background: #050505; border: 1px solid #222; border-radius: 12px; padding: 15px; resize: vertical;"></textarea>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button id="upload-btn" class="btn btn-primary" style="flex: 2; padding: 16px; border-radius: 12px; font-weight: 700; background: var(--primary); color: white; border: none; cursor: pointer;" onclick="savePost()">Publish Script</button>
            <button class="btn" style="flex: 1; background: #1a1a1a; color: #fff; border: 1px solid #333; border-radius: 12px; cursor: pointer;" onclick="switchTab('feed')">Cancel</button>
        </div>
    </div>
</div>

    <div id="section-feed" class="hidden">
    <div class="script-grid" id="scriptGrid" style="margin-top: 20px;"></div>
</div>

    <div id="section-upload" class="hidden">
        <div style="max-width: 700px; margin: auto; background: var(--bg-card); padding: 40px; border-radius: 24px; border: 1px solid var(--border);">
            <h2 id="upload-header">Upload Script</h2>
            <input type="hidden" id="edit-id">
            <input type="text" id="up-title" placeholder="Script Name">
            
            <div style="display: flex; gap: 10px;">
                <select id="up-key">
                    <option value="N/A">Key System: N/A</option>
                    <option value="Keyless">Keyless</option>
                    <option value="Key System">Key System</option>
                </select>
                <select id="up-payment">
                    <option value="N/A">Payment: N/A</option>
                    <option value="Free">Free</option>
                    <option value="Paid">Paid</option>
                </select>
            </div>

            <input type="text" id="up-gameid" placeholder="Roblox Game ID">
            <textarea id="up-features" rows="2" placeholder="Features (e.g. Auto Quest, Fly, ESP)"></textarea>
            <input type="file" id="up-thumb-file" accept="image/*">
            <textarea id="up-script" rows="10" placeholder="-- Paste Lua Code Here"></textarea>
            <button id="upload-btn" class="btn btn-primary" style="width:100%;" onclick="savePost()">Publish Script</button>
            <button class="btn" style="width:100%; background:none; color:var(--text-muted); margin-top:10px;" onclick="switchTab('feed')">Cancel</button>
        </div>
    </div>
</div>

<div id="post-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button onclick="closeModal()" style="position:absolute; top:20px; right:20px; background:none; border:none; color:white; font-size:28px; cursor:pointer; z-index: 10;">&times;</button>
        
        <div id="modal-thumb-container" style="width: 100%; height: 280px; background: #020617; border-radius: 16px; margin-bottom: 20px; overflow: hidden; border: 1px solid var(--border);">
            <img id="modal-thumbnail" src="" style="width: 100%; height: 100%; object-fit: cover; display: block;">
        </div>

        <h2 id="modal-title" style="margin:0;"></h2>
        <p id="modal-author" style="color:var(--text-muted); font-size:13px; margin:5px 0 20px 0;"></p>
        
        <div id="modal-tags" style="margin-bottom: 15px;"></div>

        <div class="interaction-row">
            <button class="stat-btn" id="like-btn" onclick="vote(1)">üëç <span id="modal-likes">0</span></button>
            <button class="stat-btn" id="dislike-btn" onclick="vote(-1)">üëé <span id="modal-dislikes">0</span></button>
            
            <div class="stat-btn" style="cursor: default; opacity: 0.8;">
                üëÅÔ∏è <span id="modal-views">0</span>
            </div>

            <button class="stat-btn" id="fav-btn" onclick="toggleFav()">‚≠ê Favorite</button>
        </div>

        <div class="code-box" id="modal-code"></div>
        
        <div style="display: flex; gap: 12px;">
            <button class="btn btn-primary" style="flex: 1; justify-content: center;" onclick="copyScript()">üìã Copy Script</button>
            <button class="btn btn-primary" style="flex: 1; justify-content: center;" onclick="downloadScript()">üì• Download Script</button>
        </div>

        <div style="margin-top:40px;">
            <h3>Comments</h3>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="comment-input" style="margin:0;" placeholder="Add a comment...">
                <button class="btn btn-primary" onclick="addComment()">Post</button>
            </div>
            <div id="comments-container"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    const _supabase = supabase.createClient('https://kappjyhgnyeetqhzwcpn.supabase.co', 'sb_publishable_iQDbMK9zbPO6Qi53bFO6pg_7qMBxYD4');
    
    // Replace your current renderFeed and savePost with these global versions:
</script>

<script>
    let currentUser = localStorage.getItem('session_user') || null;
    let activePostId = null;
    const DEFAULT_THUMB = "https://www.bing.com/th/id/OIP.YpUWqwMu822ARQxlUvP7mgHaHa?w=195&h=211&c=8&rs=1&qlt=90&o=6&pid=3.1&rm=2";

    // Creates a unique ID for guests that lasts until they clear browser data
if (!localStorage.getItem('guest_session')) {
    localStorage.setItem('guest_session', 'g-' + Math.random().toString(36).substr(2, 9));
}
const viewerId = currentUser || localStorage.getItem('guest_session');

    function pushNotif(msg, type = 'success') {
        const stack = document.getElementById('notif-stack');
        const el = document.createElement('div');
        el.className = `es-notif ${type}`;
        el.innerHTML = `<span>${msg}</span>`;
        stack.appendChild(el);
        setTimeout(() => el.classList.add('show'), 10);
        setTimeout(() => {
            el.classList.remove('show');
            setTimeout(() => el.remove(), 500);
        }, 3000);
    }

window.onload = () => {
    const navLinks = document.querySelector('.nav-links');

    if (currentUser) {
        // USER IS LOGGED IN
        if (navLinks) navLinks.classList.remove('hidden');
        document.getElementById('logout-btn')?.classList.remove('hidden');
        switchTab('feed');
    } else {
        // USER IS NOT LOGGED IN
        if (navLinks) navLinks.classList.add('hidden'); // This hides the tabs
        switchTab('auth');
    }
};

  function downloadScript() {
    // 1. Get the title and script from the modal UI instead of localStorage
    const title = document.getElementById('modal-title').innerText;
    
    // Check if your code box is a div or a textarea
    const codeBox = document.getElementById('modal-code');
    const scriptContent = codeBox.innerText || codeBox.value;

    if (!scriptContent) return pushNotif("No script content found", "danger");

    // 2. Clean filename: remove special characters and spaces
    const cleanName = title.replace(/[^a-z0-9]/gi, '').toLowerCase() || "script";
    
    // 3. Create the file blob
    const blob = new Blob([scriptContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.style.display = 'none'; // Keep it hidden
    a.href = url;
    a.download = `${cleanName}.txt`;
    
    // 4. Trigger download
    document.body.appendChild(a);
    a.click();
    
    // 5. Cleanup with a slight delay (Fixes Firefox/Chrome issues)
    setTimeout(() => {
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }, 100);
    
    pushNotif("Download Started!");
}

    function timeAgo(date) {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        if (seconds < 60) return "Just now";
        if (seconds < 3600) return Math.floor(seconds/60) + "m ago";
        if (seconds < 86400) return Math.floor(seconds/3600) + "h ago";
        return Math.floor(seconds/86400) + "d ago";
    }

    // Converts a file to a Base64 string so it can be saved in LocalStorage
const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
});

function switchTab(tabId, filter = 'recent') {
    // 1. SILENT GATEKEEPER
    // If no user is logged in, overwrite the tabId to 'auth' automatically.
    if (!currentUser) {
        tabId = 'auth';
    }

    // 2. THE RESETTER
    const sections = ['section-feed', 'section-auth', 'section-upload', 'section-your-posts'];
    
    if (tabId === 'upload' || tabId === 'auth') {
        const form = document.getElementById(`section-${tabId}`);
        if (form) {
            form.querySelectorAll('input, textarea').forEach(i => i.value = '');
            const selects = form.querySelectorAll('select');
            selects.forEach(s => s.selectedIndex = 0);

            if (tabId === 'upload') {
                const previewImg = document.getElementById('upload-img-preview');
                const placeholder = document.getElementById('upload-placeholder');
                if (previewImg) {
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                    placeholder.style.display = 'block';
                }
            }
        }
    }

    // 3. HIDE ALL & SHOW TARGET
    sections.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.classList.add('hidden');
            el.style.display = 'none';
        }
    });

    const target = document.getElementById(`section-${tabId}`);
    if (target) {
        target.classList.remove('hidden');
        
        if (tabId === 'auth' || tabId === 'upload') {
            target.style.display = 'flex';
            target.style.alignItems = 'center';
            target.style.justifyContent = 'center';
            target.style.minHeight = 'calc(100vh - 80px)';
        } else {
            target.style.display = 'block';
        }
        
        window.scrollTo(0, 0);
    }

    // 4. NAV UI RESET
    document.querySelectorAll('.tab-link').forEach(a => {
        a.classList.remove('active');
        // Only mark active if the user is logged in or if it's the auth tab
        if(a.getAttribute('onclick')?.includes(`'${tabId}'`)) a.classList.add('active');
    });

    // 5. FEED LOGIC
    if (tabId === 'feed' && currentUser) {
        renderFeed(filter);
    }
}

function previewUploadImage(input) {
    const preview = document.getElementById('upload-img-preview');
    const placeholder = document.getElementById('upload-placeholder');
    const dropZone = document.getElementById('drop-zone');

    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
            dropZone.style.borderStyle = 'solid';
            dropZone.style.borderColor = 'var(--primary)';
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function signup() {
    const userInput = document.getElementById('reg-username');
    const emailInput = document.getElementById('email');
    const passInput = document.getElementById('password');
    
    const u = userInput.value.trim();
    const e = emailInput.value.trim().toLowerCase(); 
    const p = passInput.value.trim();

    // --- 1. PROFANITY & GIBBERISH FILTER ---
    const badWords = ['swear1', 'swear2', 'admin', 'moderator']; // Add words you want to block
    const isBadUser = badWords.some(word => u.toLowerCase().includes(word));
    
    if (isBadUser) {
        return pushNotif("This username is not allowed.", "danger");
    }

    // --- 2. VALID EMAIL CHECK (No more "dfifjijit") ---
    // This regex ensures it looks like name@domain.com
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(e)) {
        return pushNotif("Please enter a valid email address.", "danger");
    }

    // --- 3. PASSWORD STRENGTH ---
    if (p.length < 6) {
        return pushNotif("Password must be at least 6 characters.", "warning");
    }

    // --- 4. USERNAME RULES ---
    if (u.length < 3 || u.length > 15) {
        return pushNotif("Username must be 3-15 characters.", "warning");
    }
    
    // Only allow letters, numbers, and underscores (no weird symbols)
    const userRegex = /^[a-zA-Z0-9_]+$/;
    if (!userRegex.test(u)) {
        return pushNotif("Username can only contain letters, numbers, and underscores.", "danger");
    }

    // --- EXISTING LOGIC: DATABASE CHECK ---
    if (localStorage.getItem(`u_${e}`)) {
        return pushNotif("Account already exists!", "danger");
    }

    const userData = { username: u, password: p };
    localStorage.setItem(`u_${e}`, JSON.stringify(userData));
    
    // Set Session
    localStorage.setItem('session_user', e);
    localStorage.setItem('session_username', u);
    
    pushNotif(`Welcome, @${u}!`);
    setTimeout(() => { location.reload(); }, 800);
}

function togglePassword() {
    // We target "password" because that is the ID in your HTML
    const passInput = document.getElementById('password');
    const eyeIcon = document.getElementById('eye-icon');

    if (!passInput || !eyeIcon) {
        console.error("Password input or eye icon not found!");
        return;
    }

    if (passInput.type === 'password') {
        passInput.type = 'text';
        // Eye-off (Slash)
        eyeIcon.innerHTML = `
            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
            <line x1="1" y1="1" x2="23" y2="23"></line>
        `;
    } else {
        passInput.type = 'password';
        // Regular Eye
        eyeIcon.innerHTML = `
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
        `;
    }
}

function login() {
    // 1. Get inputs
    const uInput = document.getElementById('reg-username').value.trim();
    const eInput = document.getElementById('email').value.trim().toLowerCase();
    const pInput = document.getElementById('password').value.trim();

    // 2. Strict empty check
    if (!uInput || !eInput || !pInput) {
        return pushNotif("All fields are required to access your account.", "warning");
    }

    // 3. Email format check (Prevents trying to login with gibberish)
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(eInput)) {
        return pushNotif("That doesn't look like a valid email.", "danger");
    }

    // 4. Retrieve account
    const storedData = localStorage.getItem(`u_${eInput}`);

    if (!storedData) {
        return pushNotif("No account linked to this email.", "danger");
    }

    // 5. Verify credentials
    try {
        const user = JSON.parse(storedData);

        // Professional check: Case-insensitive username check is safer
        const usernameMatches = user.username.toLowerCase() === uInput.toLowerCase();
        const passwordMatches = user.password === pInput;

        if (usernameMatches && passwordMatches) {
            // LOGIN SUCCESS
            currentUser = eInput; 
            localStorage.setItem('session_user', eInput); 
            localStorage.setItem('session_username', user.username);
            
            pushNotif(`Success! Welcome back, @${user.username}`, "success");
            
            setTimeout(() => {
                location.reload();
            }, 800);
        } else { 
            // LOGIN FAIL
            if (!usernameMatches) {
                pushNotif("Username does not match our records.", "danger");
            } else {
                pushNotif("Invalid password. Please try again.", "danger");
            }
            
            // Optional: Clear password field on fail for security
            document.getElementById('password').value = "";
        }
    } catch (err) {
        console.error("Login Error:", err);
        pushNotif("An error occurred during login.", "danger");
    }
}

   function logout() {
    // 1. Remove the session
    localStorage.removeItem('session_user');
    
    // 2. Clear the local variable so functions like toggleFav() stop working immediately
    currentUser = null;
    
    // 3. Optional: Push a notification so the user sees it's happening
    pushNotif("Logged out successfully", "success");
    
    // 4. Refresh to reset the UI state
    setTimeout(() => {
        location.reload();
    }, 500); // Small delay to let the notification show
}

// Add this outside the function to track state
let isSubmitting = false;

async function savePost() {
    if (isSubmitting) return;

    const title = document.getElementById('up-title').value;
    const script = document.getElementById('up-script').value;
    const editId = document.getElementById('edit-id').value;
    const fileInput = document.getElementById('up-thumb-file');
    const submitBtn = document.getElementById('upload-btn');
    
    // Retrieve the actual username we stored during login/signup
    const currentUsername = localStorage.getItem('session_username') || "Anonymous";
    
    if(!title || !script) return pushNotif("Missing Title/Script", "danger");

    isSubmitting = true;
    if (submitBtn) {
        submitBtn.innerText = "Publishing...";
        submitBtn.style.opacity = "0.7";
        submitBtn.style.cursor = "not-allowed";
    }

    let thumbData = DEFAULT_THUMB;

    if (fileInput.files && fileInput.files[0]) {
        try {
            thumbData = await toBase64(fileInput.files[0]);
        } catch (err) {
            isSubmitting = false; 
            if (submitBtn) submitBtn.innerText = "Publish Script"; 
            return pushNotif("Error processing image", "danger");
        }
    }

    // --- UPDATED POST DATA ---
    const postData = {
        title: title, 
        script: script,
        keySystem: document.getElementById('up-key').value,
        payment: document.getElementById('up-payment').value,
        gameId: document.getElementById('up-gameid').value,
        features: document.getElementById('up-features').value,
        thumb: thumbData,
        author: currentUsername, // FIX: Uses the real username now
        authorEmail: currentUser  // Keep this for ownership checks
    };

    try {
        if(editId) {
            const { error } = await _supabase
                .from('posts')
                .update(postData)
                .eq('id', editId);

            if (error) throw error;
            pushNotif("Script Updated Globally!");
        } else {
            const { error } = await _supabase
                .from('posts')
                .insert([postData]);

            if (error) throw error;
            pushNotif("Script Published to Community!");
        }

        // Reset fields
        document.getElementById('up-title').value = "";
        document.getElementById('up-script').value = "";
        document.getElementById('up-features').value = "";
        document.getElementById('up-gameid').value = "";
        fileInput.value = "";
        document.getElementById('edit-id').value = ""; 
        switchTab('feed');

    } catch (err) {
        console.error("Supabase Error:", err);
        pushNotif("Database Error: " + err.message, "danger");
    } finally {
        isSubmitting = false;
        if (submitBtn) {
            submitBtn.innerText = "Publish Script";
            submitBtn.style.opacity = "1";
            submitBtn.style.cursor = "pointer";
        }
    }
}
  async function renderFeed(filter = 'recent') {
    const grid = document.getElementById('scriptGrid');
    const search = document.getElementById('search-input').value.toLowerCase();

    // 1. Fetch Global Data from Supabase
    // We use .order() to show the newest scripts first (highest ID or created_at)
    let { data: posts, error } = await _supabase
        .from('posts')
        .select('*')
        .order('id', { ascending: false });

    if (error) {
        console.error("Supabase Error:", error);
        return pushNotif("Failed to sync global feed", "danger");
    }

    // 2. Apply Filters (Client-side for JSON arrays)
    if (filter === 'favorites') {
        posts = posts.filter(p => (p.favorites || []).includes(currentUser));
    } else if (filter === 'my') {
        posts = posts.filter(p => p.authorEmail === currentUser);
    }

    // 3. Apply Search
    if (search) {
        posts = posts.filter(p => 
            p.title.toLowerCase().includes(search) || 
            (p.features && p.features.toLowerCase().includes(search))
        );
    }

// 4. Clear Grid and Handle Empty State
    grid.innerHTML = '';

    // If posts is null (error) or an empty array (no results)
    if (!posts || posts.length === 0) {
        grid.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 100px 20px; color: var(--text-muted);">
                <div style="font-size: 50px; margin-bottom: 15px; filter: grayscale(1);">üîé</div>
                <h3 style="color: var(--text-main); margin-bottom: 8px;">No Scripts Found</h3>
                <p>Try changing your filters or be the first to publish a script!</p>
                <button class="btn" onclick="switchTab('upload')" style="margin-top: 15px; background: var(--primary); color: white;">
                    + Upload Now
                </button>
            </div>`;
        return;
    }

   // 5. Render Global Post Cards
posts.forEach(p => {
    const isOwner = p.authorEmail === currentUser;
    const isSaved = (p.favorites || []).includes(currentUser);

    // Get the dynamic "time ago" string
    const timeDisplay = p.created_at ? timeAgo(p.created_at) : "Just now";

    const viewCount = p.views ? p.views.length : 0;
    const likeCount = p.likes ? p.likes.length : 0;
    const dislikeCount = p.dislikes ? p.dislikes.length : 0;

    grid.innerHTML += `
        <div class="script-card" onclick="openPost(${p.id})">
            <div class="badge-container">
                ${isOwner ? '<div class="owner-badge">Your Post</div>' : ''}
                ${isSaved ? '<div class="saved-badge">‚≠ê Saved</div>' : ''}
            </div>

            <div class="thumb-wrapper">
                <div class="post-time-stamp">${timeDisplay}</div>
                
                <img src="${p.thumb}" class="thumb-img" onerror="this.src='${DEFAULT_THUMB}'">
            </div>
            
            <div class="card-content">
                <div style="font-weight:700; color:var(--text-main);">${p.title}</div>
                
                <div style="margin-top:8px; display:flex; gap:5px; align-items:center;">
                    <span class="tag-pill">${p.keySystem || 'N/A'}</span>
                    <span class="tag-pill">${p.payment || 'N/A'}</span>
                </div>

                <div style="margin-top:12px; display:flex; gap:10px; font-size:11px; color:var(--text-muted);">
                    <span title="Views">üëÅÔ∏è <span id="v-count-${p.id}">${viewCount}</span></span>
                    <span title="Likes">üëç <span id="l-count-${p.id}">${likeCount}</span></span>
                    <span title="Dislikes">üëé <span id="d-count-${p.id}">${dislikeCount}</span></span>
                </div>

                <div style="font-size:11px; color:var(--text-muted); margin-top:10px; display:flex; align-items:center; gap:5px;">
                    <div style="width:18px; height:18px; background:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:8px; color:white;">
                        ${p.author ? p.author[0].toUpperCase() : '?'}
                    </div>
                    @${p.author}
                </div>
            </div>

            ${isOwner ? `
            <div class="comment-menu-btn" onclick="event.stopPropagation()">
                <button class="dropdown-btn" onclick="toggleDrop('drop-${p.id}')">‚ãÆ</button>
                <div id="drop-${p.id}" class="dropdown-menu">
                    <button onclick="editPost(${p.id})">Edit Script</button>
                    <button onclick="deletePost(${p.id})" style="color:var(--danger)">Delete Permanent</button>
                </div>
            </div>` : ''}
        </div>`;
});
}

async function openPost(id) {
    activePostId = id;
    
    // 1. FETCH FRESH DATA
    const { data: p, error } = await _supabase
        .from('posts')
        .select('*')
        .eq('id', id)
        .single();
    
    if (error || !p) {
        console.error("Fetch error:", error);
        return pushNotif("Post not found", "danger");
    }

    // --- THUMBNAIL LOGIC START ---
    const modalImg = document.getElementById('modal-thumbnail');
    // Check if p.thumb or p.thumbnail_url exists in your Supabase table
    const postImage = p.thumb || p.thumbnail_url; 
    
    if (postImage && postImage.trim() !== "") {
        modalImg.src = postImage;
    } else {
        modalImg.src = DEFAULT_THUMB;
    }
    // --- THUMBNAIL LOGIC END ---

    // 2. Global View Counter Logic
    const viewer = currentUser || localStorage.getItem('guest_session') || 'guest';
    let updatedViews = p.views || [];
    
    if (!updatedViews.includes(viewer)) {
        updatedViews.push(viewer);
        await _supabase.from('posts').update({ views: updatedViews }).eq('id', id);
        const activeTabEl = document.querySelector('.tab-link.active');
        renderFeed(activeTabEl ? activeTabEl.id.replace('tab-', '') : 'recent');
    }

    // 3. Update the Modal UI
    document.getElementById('modal-title').innerText = p.title;
    document.getElementById('modal-author').innerText = `By @${p.author || p.authorEmail.split('@')[0]}`;
    
    const codeEl = document.getElementById('modal-code');
    if(codeEl.tagName === 'TEXTAREA') codeEl.value = p.script;
    else codeEl.innerText = p.script;
    
    document.getElementById('modal-likes').innerText = p.likes ? p.likes.length : 0;
    document.getElementById('modal-dislikes').innerText = p.dislikes ? p.dislikes.length : 0;
    document.getElementById('modal-views').innerText = updatedViews.length;

    // 4. Tags & Roblox Logic
    const isValidId = p.gameId && !isNaN(p.gameId) && p.gameId.toString().trim() !== "";
    const joinBtnHtml = isValidId 
        ? `<button class="btn" style="background:var(--success); color:white; font-size:12px; padding:4px 12px; margin-left: 10px;" 
            onclick="window.open('https://www.roblox.com/games/${p.gameId}/', '_blank')">üéÆ Join Game</button>` 
        : '';

    document.getElementById('modal-tags').innerHTML = `
        <span class="tag-pill" style="font-size:12px; padding:4px 12px;">${p.keySystem || 'No Key'}</span>
        <span class="tag-pill" style="font-size:12px; padding:4px 12px;">${p.payment || 'Free'}</span>
        ${joinBtnHtml}
    `;

    // 5. Interaction UI & Comments
    updateInteractionUI(p);
    renderComments(p.comments || [], p.authorEmail);
    
    document.getElementById('post-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden'; 
}

// 1. Add this variable at the very top of your script file (Global Scope)
let isVoting = false; 

/**
 * Handles liking/disliking with Optimistic UI updates and Alt-Account protection
 * @param {number} type - 1 for Like, -1 for Dislike
 */
async function vote(type) {
    // Basic Auth Check
    if (!currentUser) return pushNotif("Please login to vote", "danger");
    
    // Prevent spam-clicks and race conditions between account switches
    if (isVoting) return;

    // --- STEP 1: UI SNAPSHOT (For Reverting on Error) ---
    const lBtn = document.getElementById('like-btn');
    const dBtn = document.getElementById('dislike-btn');
    const lCountEl = document.getElementById('modal-likes');
    const dCountEl = document.getElementById('modal-dislikes');

    const oldL = parseInt(lCountEl.innerText) || 0;
    const oldD = parseInt(dCountEl.innerText) || 0;
    const wasLiked = lBtn.classList.contains('active-up');
    const wasDisliked = dBtn.classList.contains('active-down');

    // Lock the function
    isVoting = true;

    // --- STEP 2: INSTANT VISUAL CHANGE (Optimistic UI) ---
    if (type === 1) { // User clicked Like
        if (wasLiked) {
            lBtn.classList.remove('active-up');
            lCountEl.innerText = Math.max(0, oldL - 1);
        } else {
            lBtn.classList.add('active-up');
            lCountEl.innerText = oldL + 1;
            if (wasDisliked) {
                dBtn.classList.remove('active-down');
                dCountEl.innerText = Math.max(0, oldD - 1);
            }
        }
    } else { // User clicked Dislike
        if (wasDisliked) {
            dBtn.classList.remove('active-down');
            dCountEl.innerText = Math.max(0, oldD - 1);
        } else {
            dBtn.classList.add('active-down');
            dCountEl.innerText = oldD + 1;
            if (wasLiked) {
                lBtn.classList.remove('active-up');
                lCountEl.innerText = Math.max(0, oldL - 1);
            }
        }
    }

    // --- STEP 3: BACKGROUND SYNC ---
    try {
        // Capture the currentUser RIGHT NOW to ensure the alt-account is the one recorded
        const votingUser = currentUser;

        // Fetch fresh arrays from Supabase to prevent overwriting other people's votes
        const { data: post, error: fetchError } = await _supabase
            .from('posts')
            .select('likes, dislikes')
            .eq('id', activePostId)
            .single();

        if (fetchError || !post) throw new Error("Sync failed");

        let upVotes = post.likes || [];
        let downVotes = post.dislikes || [];

        if (type === 1) {
            if (upVotes.includes(votingUser)) {
                upVotes = upVotes.filter(u => u !== votingUser);
            } else {
                upVotes.push(votingUser);
                downVotes = downVotes.filter(u => u !== votingUser);
            }
        } else {
            if (downVotes.includes(votingUser)) {
                downVotes = downVotes.filter(u => u !== votingUser);
            } else {
                downVotes.push(votingUser);
                upVotes = upVotes.filter(u => u !== votingUser);
            }
        }

        const { error: updateError } = await _supabase
            .from('posts')
            .update({ likes: upVotes, dislikes: downVotes })
            .eq('id', activePostId);

        if (updateError) throw updateError;

        // Final UI Polish: Ensure counts match the DB exactly
        lCountEl.innerText = upVotes.length;
        dCountEl.innerText = downVotes.length;

        // Refresh background feed quietly
        const activeFilter = document.querySelector('.tab-link.active')?.id.replace('tab-', '') || 'recent';
        renderFeed(activeFilter);

    } catch (err) {
        console.error("Voting Error:", err);
        pushNotif("Voting failed. Try again.", "danger");

        // --- STEP 4: REVERT ON FAILURE ---
        lCountEl.innerText = oldL;
        dCountEl.innerText = oldD;
        lBtn.classList.toggle('active-up', wasLiked);
        dBtn.classList.toggle('active-down', wasDisliked);
    } finally {
        // Unlock the function
        isVoting = false;
    }
}

async function toggleFav() {
    if (!currentUser) return pushNotif("Please login to favorite", "danger");

    const favBtn = document.getElementById('fav-btn');
    if (!favBtn) return;

    // 1. OPTIMISTIC UI (INSTANT)
    // We check the current state and flip it immediately before talking to the database
    const currentlySaved = favBtn.classList.contains('active-fav');
    const willBeSaved = !currentlySaved;

    // Flip colors and text instantly
    favBtn.classList.toggle('active-fav', willBeSaved);
    favBtn.innerHTML = willBeSaved ? `‚≠ê Favorite` : `‚≠ê Favorite`;

    // 2. BACKGROUND SYNC (SILENT)
    // Now we do the heavy lifting while the user is already happy
    const { data: p, error: fetchError } = await _supabase
        .from('posts')
        .select('favorites')
        .eq('id', activePostId)
        .single();

    if (fetchError) {
        // Rollback UI if the cloud fetch fails
        favBtn.classList.toggle('active-fav', currentlySaved);
        favBtn.innerHTML = currentlySaved ? `‚≠ê Favorite` : `‚≠ê Favorite`;
        return pushNotif("Sync error", "danger");
    }

    let favs = p.favorites || [];
    
    // Process logic based on our optimistic choice
    if (willBeSaved) {
        if (!favs.includes(currentUser)) favs.push(currentUser);
    } else {
        favs = favs.filter(u => u !== currentUser);
    }

    // 3. PUSH TO CLOUD
    const { error: upError } = await _supabase
        .from('posts')
        .update({ favorites: favs })
        .eq('id', activePostId);

    if (upError) {
        // Rollback UI if the update fails
        favBtn.classList.toggle('active-fav', currentlySaved);
        favBtn.innerHTML = currentlySaved ? `‚≠ê Favorite` : `‚≠ê Favorite`;
        return pushNotif("Failed to save globally", "danger");
    }

    // Notify user only after successful cloud sync
    pushNotif(willBeSaved ? "Added to Saved" : "Removed from Saved", willBeSaved ? "success" : "warning");
    
    // 4. BACKGROUND FEED REFRESH
    // We don't 'await' this so the modal stays smooth
    const activeTab = document.querySelector('.tab-link.active')?.id.replace('tab-', '') || 'recent';
    renderFeed(activeTab);
}

 /**
 * Synchronizes the button states (Like/Dislike/Favorite) with the fresh post data
 * @param {Object} p - The fresh post object from Supabase
 */
function updateInteractionUI(p) {
    const favBtn = document.getElementById('fav-btn');
    const likeBtn = document.getElementById('like-btn');
    const dislikeBtn = document.getElementById('dislike-btn');

    // Ensure we are checking against the current active session
    // If currentUser is null (logged out), these will all be false
    const isFav = (p.favorites || []).includes(currentUser);
    const isLiked = (p.likes || []).includes(currentUser);
    const isDisliked = (p.dislikes || []).includes(currentUser);

    if (favBtn) {
        favBtn.classList.toggle('active-fav', isFav);
        favBtn.innerHTML = isFav ? `‚≠ê Favorited` : `‚≠ê Favorite`;
    }

    if (likeBtn) {
        likeBtn.classList.toggle('active-up', isLiked);
    }

    if (dislikeBtn) {
        dislikeBtn.classList.toggle('active-down', isDisliked);
    }
    
    // Refresh the numbers too, so Alt acc sees "1" before they make it "2"
    document.getElementById('modal-likes').innerText = (p.likes || []).length;
    document.getElementById('modal-dislikes').innerText = (p.dislikes || []).length;
}

// Add this at the top of your script tag with your other global variables
let isCommenting = false; 

async function addComment() {
    if (!currentUser) return pushNotif("Please login to comment", "danger");
    if (isCommenting) return; 

    const input = document.getElementById('comment-input');
    // Using a generic selector if class isn't present, or update your HTML to include .comment-submit-btn
    const btn = document.querySelector('.btn-primary[onclick="addComment()"]') || document.querySelector('.comment-submit-btn');
    const val = input.value.trim();
    
    if (!val) return;

    isCommenting = true; 
    if(btn) {
        btn.disabled = true;
        btn.innerText = "...";
    }

    // 1. Fetch the LATEST comments to ensure we don't overwrite others
    const { data: p, error: fetchError } = await _supabase
        .from('posts')
        .select('comments, authorEmail')
        .eq('id', activePostId)
        .single();

    if (fetchError) {
        isCommenting = false;
        if(btn) { btn.disabled = false; btn.innerText = "Post"; }
        return pushNotif("Failed to sync comments", "danger");
    }

    const comments = p.comments || [];

    // 2. ANTI-SPAM (5-second cooldown)
    const myLastComment = [...comments].reverse().find(c => c.email === currentUser);
    if (myLastComment) {
        const timeSinceLast = Date.now() - new Date(myLastComment.date).getTime();
        if (timeSinceLast < 5000) { 
            isCommenting = false;
            if(btn) { btn.disabled = false; btn.innerText = "Post"; }
            return pushNotif("Wait 5s before posting again", "warning");
        }
    }

    // 3. Create comment using the STORED username
    const currentUsername = localStorage.getItem('session_username') || currentUser.split('@')[0];
    
    const newComment = {
        id: Date.now(),
        user: currentUsername, // FIX: Uses real display name
        email: currentUser,
        text: val,
        date: new Date().toISOString()
    };

    const updatedComments = [...comments, newComment];

    // 4. Update Supabase
    const { error: updateError } = await _supabase
        .from('posts')
        .update({ comments: updatedComments })
        .eq('id', activePostId);

    // 5. Cleanup
    isCommenting = false; 
    if(btn) { 
        btn.disabled = false; 
        btn.innerText = "Post"; 
    }

    if (updateError) {
        return pushNotif("Error posting comment", "danger");
    }

    input.value = '';
    renderComments(updatedComments, p.authorEmail);
    pushNotif("Comment posted!");
}

/**
 * Renders the comment section for a specific post
 * @param {Array} comments - Array of comment objects from Supabase
 * @param {string} ownerEmail - The email of the post creator (to show the crown)
 */
function renderComments(comments, ownerEmail) {
    const container = document.getElementById('comments-container');
    if (!container) return;
    
    // Clear current view
    container.innerHTML = '';
    
    // 1. Handle Empty State
    if (!comments || comments.length === 0) {
        container.innerHTML = '<p style="color:var(--text-muted); font-size:13px; text-align:center; padding:20px;">No comments yet. Be the first to speak!</p>';
        return;
    }
    
    // 2. Sort and Render (Newest first)
    comments.slice().reverse().forEach(c => {
        // PERMISSIONS & IDENTITY CHECKS
        const isMe = c.email === currentUser;
        const isAuthor = c.email === ownerEmail;
        const canMod = isMe || (currentUser && ownerEmail === currentUser);

        // Tags logic
        const crownHtml = isAuthor ? `<span title="Post Owner" style="cursor:help; margin-left:4px; filter: drop-shadow(0 0 2px gold);">üëë</span>` : '';
        const youTagHtml = isMe ? `<span style="font-size: 10px; background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; font-weight: bold; letter-spacing: 0.5px;">YOU</span>` : '';

        container.innerHTML += `
            <div class="comment" style="position: relative; padding: 15px; border-bottom: 1px solid #1e293b;">
                <div class="comment-top">
                    <div class="comment-info">
                        <span class="comment-user" style="font-weight: 600; color: ${isAuthor ? 'var(--warning)' : 'var(--primary-light)'}; display: flex; align-items: center;">
                            @${c.user} ${crownHtml} ${youTagHtml}
                        </span>
                        
                        <span class="comment-date" style="font-size: 11px; color: var(--text-muted); margin-left: 0; margin-top: 4px; display: block;">
                            ${timeAgo(c.date)} 
                            ${c.isEdited ? '<span style="font-style: italic; opacity: 0.6; margin-left: 5px;">(Edited)</span>' : ''}
                        </span>
                    </div>
                </div>

                <div class="comment-body" id="text-${c.id}" style="margin-top: 8px; font-size: 14px; line-height: 1.5; color: #e2e8f0;">
                    ${c.text}
                </div>

                <div id="edit-ctrl-${c.id}" class="hidden" style="margin-top: 10px;">
                    <input type="text" id="input-${c.id}" 
                        value="${c.text}" 
                        style="width: 100%; margin: 0; font-size: 13px; padding: 10px; background: #020617; border: 1px solid var(--primary); border-radius: 4px; color: white;">
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-primary" style="padding: 4px 12px; font-size: 11px;" onclick="saveCommentUpdate(${c.id})">Save</button>
                        <button class="btn" style="padding: 4px 12px; font-size: 11px; background: #334155; color: white;" onclick="cancelCommentEdit(${c.id})">Cancel</button>
                    </div>
                </div>

                ${canMod ? `
                <div class="comment-menu-btn" style="position: absolute; top: 12px; right: 12px;">
                    <button class="dropdown-btn" style="background:transparent; border:none; color:var(--text-muted); cursor:pointer; font-size:18px;" onclick="toggleDrop('c-drop-${c.id}')">‚ãÆ</button>
                    <div id="c-drop-${c.id}" class="dropdown-menu" style="right: 0; top: 30px; min-width: 100px;">
                        ${isMe ? `<button onclick="editComment(${c.id})" style="width:100%; text-align:left;">Edit</button>` : ''}
                        <button onclick="delComment(${c.id})" style="width:100%; text-align:left; color: var(--danger)">Delete</button>
                    </div>
                </div>` : ''}
            </div>`;
    });
}

   /**
 * Deletes a specific comment from the cloud and refreshes the UI
 * @param {number|string} commentId - The unique ID of the comment to remove
 */
async function delComment(commentId) {
    if (!activePostId) return pushNotif("Error: Post ID not found", "danger");

    showConfirm(
        "Delete Comment?", 
        "Are you sure you want to remove this? This cannot be undone.", 
        async () => {
            // 1. Fetch the latest comments from Supabase
            const { data: p, error: fetchError } = await _supabase
                .from('posts')
                .select('comments, authorEmail')
                .eq('id', activePostId)
                .single();

            if (fetchError || !p) {
                console.error("Sync Error:", fetchError);
                return pushNotif("Error syncing comments", "danger");
            }

            // 2. Filter out the comment by its ID
            // Using != instead of !== if commentId type varies (string vs number)
            const updatedComments = (p.comments || []).filter(c => c.id != commentId);

            // 3. Update the cloud database
            const { error: updateError } = await _supabase
                .from('posts')
                .update({ comments: updatedComments })
                .eq('id', activePostId);

            if (updateError) {
                console.error("Cloud Update Error:", updateError);
                pushNotif("Failed to delete from cloud", "danger");
            } else {
                pushNotif("Comment removed", "success");
                
                // 4. AUTO-REFRESH UI
                // We pass the fresh array and the authorEmail back to the renderer
                renderComments(updatedComments, p.authorEmail);
                
                // 5. Update the comment count on the background feed card
                const activeTab = document.querySelector('.tab-link.active')?.id.replace('tab-', '') || 'recent';
                renderFeed(activeTab);
            }
        }
    );
}

let isUpdatingComment = false; // Spam lock

/**
 * Toggles the UI into Edit Mode for a specific comment
 * @param {number|string} commentId - The unique ID of the comment to edit
 */
function editComment(commentId) {
    // 1. Close dropdown menu
    const menu = document.getElementById(`c-drop-${commentId}`);
    if (menu) menu.classList.remove('active');

    // 2. Identify elements
    const textEl = document.getElementById(`text-${commentId}`);
    const inputEl = document.getElementById(`input-${commentId}`);
    const ctrlEl = document.getElementById(`edit-ctrl-${commentId}`);

    // 3. THE FIX: Force it to be blank every time they click edit 
    // instead of showing the old text.
    if (inputEl) {
        inputEl.value = ""; 
        inputEl.placeholder = "Type new comment...";
    }

    // 4. Swap UI Visibility
    if (textEl) textEl.classList.add('hidden');
    if (ctrlEl) ctrlEl.classList.remove('hidden');
    
    // 5. UX: Immediately focus the input for the user
    if (inputEl) inputEl.focus();
}

/**
 * Cancels the edit mode and restores the original comment view
 * @param {number|string} commentId - The unique ID of the comment
 */
function cancelCommentEdit(commentId) {
    const textEl = document.getElementById(`text-${commentId}`);
    const ctrlEl = document.getElementById(`edit-ctrl-${commentId}`);
    const inputEl = document.getElementById(`input-${commentId}`);

    // 1. Restore the original text visibility
    if (textEl) textEl.classList.remove('hidden');

    // 2. Hide the edit controls (input and buttons)
    if (ctrlEl) ctrlEl.classList.add('hidden');

    // 3. THE FIX: Clear the input on cancel to prevent data ghosting 
    // when the user re-opens the edit mode later.
    if (inputEl) {
        inputEl.value = "";
    }

    // 4. Safety: Ensure the dropdown menu is closed
    const menu = document.getElementById(`c-drop-${commentId}`);
    if (menu) menu.classList.remove('active');
}

/**
 * Saves an edited comment to the cloud and refreshes the view
 * @param {number|string} commentId - The ID of the comment being updated
 */
async function saveCommentUpdate(commentId) {
    // 1. Pre-flight Checks
    if (isUpdatingComment) return;
    if (!activePostId) return pushNotif("Error: Post reference lost", "danger");

    const inputEl = document.getElementById(`input-${commentId}`);
    const newText = inputEl?.value.trim();

    if (!newText) return pushNotif("Comment cannot be empty", "warning");

    // 2. Lock and Show Loading State
    isUpdatingComment = true;
    const saveBtn = document.querySelector(`#edit-ctrl-${commentId} .btn-primary`);
    const originalBtnText = saveBtn ? saveBtn.innerText : "Save";
    
    if (saveBtn) {
        saveBtn.innerText = "Saving...";
        saveBtn.disabled = true;
    }

    try {
        // 3. Fetch latest data to prevent overwriting other users' new comments
        const { data: p, error: fetchError } = await _supabase
            .from('posts')
            .select('comments, authorEmail')
            .eq('id', activePostId)
            .single();

        if (fetchError || !p) throw fetchError;

        // 4. Update the specific comment in the local array
        const updatedComments = p.comments.map(c => {
            // Use == to handle potential string/number ID mismatches
            if (c.id == commentId) {
                return { 
                    ...c, 
                    text: newText, 
                    isEdited: true, 
                    lastEdited: new Date().toISOString() 
                };
            }
            return c;
        });

        // 5. Push the updated array back to Supabase
        const { error: updateError } = await _supabase
            .from('posts')
            .update({ comments: updatedComments })
            .eq('id', activePostId);

        if (updateError) throw updateError;

        // 6. Success: Notify and Re-render
        pushNotif("Comment updated!", "success");
        renderComments(updatedComments, p.authorEmail);

    } catch (err) {
        console.error("Comment Update Error:", err);
        pushNotif("Error saving comment", "danger");
        
        // Manual button reset if we caught an error before the finally block
        if (saveBtn) saveBtn.innerText = originalBtnText;
    } finally {
        // 7. Global Reset
        isUpdatingComment = false;
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerText = originalBtnText;
        }
    }
}

  function toggleDrop(id) {
    const el = document.getElementById(id);
    if (!el) return;

    const isOpen = el.classList.contains('active');

    // Close all other open menus first
    document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active'));

    // If it wasn't open, open it now
    if (!isOpen) {
        el.classList.add('active');
    }
}


let confirmCallback = null;

/**
 * Shows a custom confirmation modal with async handling
 * @param {string} title - The header text for the modal
 * @param {string} message - The body description
 * @param {Function} onConfirm - The async function to run (e.g., deletePost logic)
 */
function showConfirm(title, message, onConfirm) {
    const modal = document.getElementById('confirm-modal');
    const confirmBtn = document.getElementById('confirm-yes-btn');
    const cancelBtn = document.getElementById('confirm-no-btn'); // Assuming you have a cancel btn

    // 1. Set the Text Content
    document.getElementById('confirm-title').innerText = title;
    document.getElementById('confirm-msg').innerText = message;
    
    // 2. Reveal the Modal
    modal.classList.remove('hidden');

    // 3. Overwrite the click handler to prevent "ghost" executions from previous calls
    confirmBtn.onclick = async () => {
        // Change button state to "Loading"
        const originalText = confirmBtn.innerText;
        confirmBtn.innerText = "Processing...";
        confirmBtn.disabled = true;
        
        // Add a subtle style change to show it's working
        confirmBtn.style.opacity = "0.7";
        confirmBtn.style.cursor = "not-allowed";

        try {
            // Run the passed-in logic (Delete/Update/etc)
            await onConfirm(); 
        } catch (err) {
            console.error("Action failed:", err);
        } finally {
            // Revert button state regardless of success or failure
            confirmBtn.innerText = originalText;
            confirmBtn.disabled = false;
            confirmBtn.style.opacity = "1";
            confirmBtn.style.cursor = "pointer";
            
            // Close the modal
            closeConfirm();
        }
    };

    // 4. Ensure the Cancel button just closes the modal
    if (cancelBtn) {
        cancelBtn.onclick = () => closeConfirm();
    }
}

// Helper to hide the modal
function closeConfirm() {
    document.getElementById('confirm-modal').classList.add('hidden');
}

/**
 * Hides the confirmation modal and resets UI states
 */
function closeConfirm() {
    const modal = document.getElementById('confirm-modal');
    const confirmBtn = document.getElementById('confirm-yes-btn');

    // 1. Hide the modal container
    modal.classList.add('hidden');

    // 2. Safety Reset: Ensure the button is not stuck in a disabled state 
    // if the modal was closed while a process was running
    if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = "1";
        confirmBtn.style.cursor = "pointer";
    }

    // 3. Clear the callback reference to keep memory clean
    confirmCallback = null;
}

/**
 * Global Delete Function
 * Deletes a post from Supabase and auto-refreshes the current feed view.
 * @param {string|number} id - The unique ID of the post to delete.
 */
async function deletePost(id) {
    showConfirm(
        "Delete Post?", 
        "Are you sure you want to remove this script? This will delete all likes and comments permanently.", 
        async () => {
            // 1. Delete from Supabase
            const { error } = await _supabase
                .from('posts')
                .delete()
                .eq('id', id);

            if (error) {
                console.error("Delete error:", error);
                return pushNotif("Failed to delete from cloud", "danger");
            }

            // 2. UI Feedback
            // Note: closeConfirm() is called automatically by your showConfirm logic,
            // but we call pushNotif here to alert the user.
            pushNotif("Script Deleted Successfully", "danger");
            
            // 3. AUTO-REFRESH LOGIC
            // Get the current active tab (e.g., 'recent', 'popular', 'my-posts')
            const activeTabLink = document.querySelector('.tab-link.active');
            
            // Fallback to 'recent' if for some reason activeTabLink is null
            const activeTab = activeTabLink 
                ? activeTabLink.id.replace('tab-', '') 
                : 'recent';

            // Re-render the feed to show the item is gone
            renderFeed(activeTab);
        }
    );
}

/**
 * Global Edit Function
 * Fetches the most recent script data and populates the upload form.
 * @param {string|number} id - The unique ID of the post to edit.
 */
async function editPost(id) {
    // 1. Show a quick notification so the user knows it's loading
    pushNotif("Loading script data...", "success");

    // 2. Fetch the latest data from the cloud
    const { data: p, error } = await _supabase
        .from('posts')
        .select('*')
        .eq('id', id)
        .single();

    if (error || !p) {
        console.error("Edit fetch error:", error);
        return pushNotif("Could not find this script in the database", "danger");
    }

    // 3. Fill the Upload Form with the Cloud Data
    // Ensure you have a hidden input: <input type="hidden" id="edit-id">
    document.getElementById('edit-id').value = p.id;
    document.getElementById('up-title').value = p.title;
    document.getElementById('up-script').value = p.script;
    document.getElementById('up-key').value = p.keySystem || "N/A";
    document.getElementById('up-payment').value = p.payment || "N/A";
    document.getElementById('up-gameid').value = p.gameId || "";
    document.getElementById('up-features').value = p.features || "";

    // 4. Update the UI text to show we are in "Edit Mode"
    document.getElementById('upload-header').innerText = "Edit Script";
    
    const upBtn = document.getElementById('upload-btn');
    upBtn.innerText = "Update Global Script";
    
    // Optional: Add a visual cue (color change) to the button so user knows they are editing
    upBtn.style.background = "var(--success)"; 

    // 5. Switch to the upload tab
    switchTab('upload');
}

    function copyScript() {
        navigator.clipboard.writeText(document.getElementById('modal-code').innerText);
        pushNotif("Code Copied!");
    }

    function closeModal() { document.getElementById('post-modal').classList.add('hidden'); }

    window.onclick = (e) => {
        if (!e.target.matches('.dropdown-btn')) {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active'));
        }
    }
</script>
</body>
</html>
